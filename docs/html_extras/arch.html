
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C4 Model Snapshot</title>
  
  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // Enable dark mode based on class
    }
  </script>

  <!-- Markdown and Sanitizer Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <!-- Base Styles -->
  <style>
    @import url('https://unpkg.com/reactflow@11/dist/style.css');
    body, html, #root {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .react-flow__attribution { display: none; }

    /* Basic Markdown styling */
    .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-top: 0.8em; margin-bottom: 0.4em; }
    .markdown-content h1 { font-size: 1.25em; }
    .markdown-content h2 { font-size: 1.15em; }
    .markdown-content h3 { font-size: 1.1em; }
    .markdown-content p { margin-bottom: 0.8em; line-height: 1.6; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.8em; list-style: revert; }
    .markdown-content a { color: #2563eb; text-decoration: underline; }
    .markdown-content code { background-color: #e5e7eb; padding: 0.2em 0.4em; font-size: 85%; border-radius: 3px; }
    .markdown-content pre { background-color: #e5e7eb; padding: 1em; border-radius: 5px; overflow-x: auto; }
    
    body.dark .markdown-content a { color: #60a5fa; }
    body.dark .markdown-content code { background-color: #374151; }
    body.dark .markdown-content pre { background-color: #374151; }
  </style>
</head>
<body class="light">
  <div id="root" class="bg-gray-50 dark:bg-gray-800"></div>

  <!-- Dependencies from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>

  <script type="module">
    // React and ReactDOM are loaded into the global scope from their respective scripts.
    const React = window.React;
    const ReactDOM = window.ReactDOM;

    // React Flow components are loaded onto the window.ReactFlow object.
    const {
      ReactFlow,
      Background,
      Controls,
      Handle,
      MiniMap,
      NodeToolbar,
      Position
    } = window.ReactFlow;

    // --- Data Injected from Export ---
    const initialNodes = [
  {
    "id": "user_ext",
    "type": "c4-person",
    "position": {
      "x": 175,
      "y": 0
    },
    "data": {
      "id": "user_ext",
      "label": "Usuário / Client",
      "c4Type": "person",
      "description": "Usuário interagindo via Playground ou Client API.",
      "parentId": null
    }
  },
  {
    "id": "auth_google",
    "type": "c4-software_system",
    "position": {
      "x": 0,
      "y": 600
    },
    "data": {
      "id": "auth_google",
      "label": "Google Auth Service",
      "c4Type": "software_system",
      "description": "Provedor de identidade para autenticação OAuth2.",
      "parentId": null
    }
  },
  {
    "id": "swapi_ext",
    "type": "c4-software_system",
    "position": {
      "x": 333.9080459770114,
      "y": 613.9463601532567
    },
    "data": {
      "id": "swapi_ext",
      "label": "SWAPI (External)",
      "c4Type": "software_system",
      "description": "API original de Star Wars (Fonte de dados primária).",
      "parentId": null
    }
  },
  {
    "id": "sys_main",
    "type": "c4-software_system",
    "position": {
      "x": 340,
      "y": 300
    },
    "data": {
      "id": "sys_main",
      "label": "Star Wars Insights Platform",
      "c4Type": "software_system",
      "description": "Ecossistema inteligente, escalável e de alto desempenho, projetada para transformar a exploração do universo Star Wars.",
      "parentId": null
    }
  },
  {
    "id": "api_gateway",
    "type": "c4-container",
    "position": {
      "x": 175,
      "y": 0
    },
    "data": {
      "id": "api_gateway",
      "label": "API Gateway",
      "c4Type": "container",
      "description": "Ponto de entrada e gerenciamento de tráfego.",
      "parentId": "sys_main"
    }
  },
  {
    "id": "cf_backend",
    "type": "c4-container",
    "position": {
      "x": 175,
      "y": 300
    },
    "data": {
      "id": "cf_backend",
      "label": "Aplicação",
      "c4Type": "container",
      "description": "## Orquestrador serverless que executa a lógica de negócio em Python.",
      "technology": "Cloud Functions/ Python",
      "parentId": "sys_main"
    }
  },
  {
    "id": "firestore_db",
    "type": "c4-container",
    "position": {
      "x": 173.1377212637608,
      "y": 580.0155617247187
    },
    "data": {
      "id": "firestore_db",
      "label": "GCP Firestore",
      "c4Type": "container",
      "description": "Persistência de logs de busca e cache de documentos.",
      "parentId": "sys_main"
    }
  },
  {
    "id": "node-cpt0eihwq",
    "type": "c4-component",
    "position": {
      "x": 350,
      "y": 0
    },
    "data": {
      "id": "node-cpt0eihwq",
      "label": "Main.py",
      "c4Type": "component",
      "description": "Função principal do Cloud Function, responsável por lidar com requisições HTTP e rotear as funções pedidas pelo Api Gateway para os respectivos Controllers.",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-x4x26svm8",
    "type": "c4-component",
    "position": {
      "x": 525,
      "y": 300
    },
    "data": {
      "id": "node-x4x26svm8",
      "label": "InsightController",
      "c4Type": "component",
      "description": "# Controlador Principal\n\n        Parameters\n        ----------\n        db_manager : app.models.database.FirestoreManager\n            Gerenciador de banco de dados do Firebase.\n        swapi_client : app.models.swapi.SWAPIClient\n            Cliente da API do SWAPI.\n\n        Attributes\n        -------\n        db : app.models.database.FirestoreManager\n            Gerenciador de banco de dados do Firebase.\n        swapi : app.models.swapi.SWAPIClient\n            Cliente da API do SWAPI.\n        np : app.controllers.nlp_controller.NLPController\n            Controlador de entidades nomeadas.\n        data_service : app.models.data_service.DataService\n            Servi o de dados do Star Wars.",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-smf4bzv1p",
    "type": "c4-component",
    "position": {
      "x": 0,
      "y": 300
    },
    "data": {
      "id": "node-smf4bzv1p",
      "label": "AuthController",
      "c4Type": "component",
      "description": "Controlador de autenticação",
      "technology": "Python/Google OAuth",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-ezy1qb201",
    "type": "c4-component",
    "position": {
      "x": 0,
      "y": 600
    },
    "data": {
      "id": "node-ezy1qb201",
      "label": "Auth Utils",
      "c4Type": "component",
      "description": "Utilitários de autenticação, que contem métodos que :\n\n- Verifica se o token de acesso fornecido é válido, com base em Google OAuth2.\n\n- Retorna a URL para autenticação com a conta Google.\n\n-  Troca o código de autenticação pelo token de acesso.",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-mf0zcesbn",
    "type": "c4-component",
    "position": {
      "x": 525,
      "y": 900
    },
    "data": {
      "id": "node-mf0zcesbn",
      "label": "DatabaseModel",
      "c4Type": "component",
      "description": "Modelo Firestore com métodos facilitadores",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-mg1nadgs5",
    "type": "c4-component",
    "position": {
      "x": 875,
      "y": 900
    },
    "data": {
      "id": "node-mg1nadgs5",
      "label": "SWAPIClient",
      "c4Type": "component",
      "description": "Cliente da API SWAPI",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-35j970kjo",
    "type": "c4-component",
    "position": {
      "x": 875,
      "y": 1200
    },
    "data": {
      "id": "node-35j970kjo",
      "label": "EntitiesModel",
      "c4Type": "component",
      "description": "Modelos de Entidades Retornadas pelo SWAPI, com tratamento utilizando o pydantic.\n\nEx: Starships, Planets e etc.",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-gjatkc72v",
    "type": "c4-component",
    "position": {
      "x": 350,
      "y": 600
    },
    "data": {
      "id": "node-gjatkc72v",
      "label": "NLPServices",
      "c4Type": "component",
      "description": "Serviço de Processamento de Linguagem Natural que utiliza NLTK",
      "technology": "",
      "parentId": "cf_backend"
    }
  },
  {
    "id": "node-hrl2x8zgs",
    "type": "c4-component",
    "position": {
      "x": 700,
      "y": 600
    },
    "width": 200,
    "height": 100,
    "data": {
      "id": "node-hrl2x8zgs",
      "label": "DataServices",
      "c4Type": "component",
      "description": "Serviço de Hidratação e Manipulação de Dados",
      "technology": "",
      "parentId": "cf_backend"
    }
  }
];
    const initialEdges = [
  {
    "id": "rel_auth",
    "source": "user_ext",
    "target": "auth_google",
    "label": "Autentica"
  },
  {
    "id": "rel_request",
    "source": "user_ext",
    "target": "api_gateway",
    "label": "2. Envia Query (Bearer)"
  },
  {
    "id": "rel_gw_to_cf",
    "source": "api_gateway",
    "target": "cf_backend",
    "label": "Encaminha requisição"
  },
  {
    "id": "rel_db",
    "source": "cf_backend",
    "target": "firestore_db",
    "label": "Cache e Histórico"
  },
  {
    "id": "rel_external",
    "source": "cf_backend",
    "target": "swapi_ext",
    "label": "Busca dados (Cache-miss)"
  },
  {
    "id": "rel-3avnxmbex",
    "source": "user_ext",
    "target": "sys_main",
    "label": "Acessa"
  },
  {
    "id": "rel-wgx3jzitw",
    "source": "sys_main",
    "target": "swapi_ext",
    "label": "Captura Informações"
  },
  {
    "id": "rel-vpp1v0zjn",
    "source": "sys_main",
    "target": "auth_google",
    "label": "Valida Autenticação"
  },
  {
    "id": "rel-ki71gsm0q",
    "source": "node-cpt0eihwq",
    "target": "node-x4x26svm8",
    "label": ""
  },
  {
    "id": "rel-9ruxqx1xa",
    "source": "node-cpt0eihwq",
    "target": "node-smf4bzv1p",
    "label": ""
  },
  {
    "id": "rel-ix11el0vs",
    "source": "node-smf4bzv1p",
    "target": "node-ezy1qb201",
    "label": "uses"
  },
  {
    "id": "rel-nac8ymowi",
    "source": "node-x4x26svm8",
    "target": "node-hrl2x8zgs",
    "label": "uses"
  },
  {
    "id": "rel-7ethu0auj",
    "source": "node-hrl2x8zgs",
    "target": "node-mg1nadgs5",
    "label": "uses"
  },
  {
    "id": "rel-k6iat1lza",
    "source": "node-hrl2x8zgs",
    "target": "node-mf0zcesbn",
    "label": "uses"
  },
  {
    "id": "rel-4hn1ehoik",
    "source": "node-mg1nadgs5",
    "target": "node-35j970kjo",
    "label": "uses"
  },
  {
    "id": "rel-ccr7guq1a",
    "source": "node-x4x26svm8",
    "target": "node-gjatkc72v",
    "label": "uses"
  }
];
    // ---------------------------------

    const C4Node = ({ data, type, selected }) => {
      const nodeStyles = {
        'c4-person': "bg-[#08427b] text-white rounded-[2rem]",
        'c4-software_system': "bg-[#1168bd] text-white rounded-md",
        'c4-container': "bg-[#438dd5] text-white rounded-md",
        'c4-component': "bg-[#6d9eeb] text-white rounded-md",
      };

      const selectedClasses = selected ? "border-yellow-400 ring-4 ring-yellow-400/20" : "border-black/10";
      const typeStyle = nodeStyles[type] || nodeStyles['c4-software_system'];

      const mainDivClasses = [
        "w-full h-full px-4 py-3 shadow-xl border-2 flex flex-col justify-center items-center text-center overflow-hidden select-none",
        selectedClasses,
        typeStyle
      ].join(' ');

      return React.createElement('div', { className: mainDivClasses },
        React.createElement(Handle, { type: 'target', position: 'top', className: 'opacity-0' }),
        React.createElement(Handle, { type: 'source', position: 'bottom', className: 'opacity-0' }),
        React.createElement('div', { className: "flex flex-col gap-1 pointer-events-none" },
          React.createElement('span', { className: "text-[9px] font-bold uppercase opacity-70 tracking-wider whitespace-nowrap" },
            (data.c4Type || '').replace('_', ' ')
          ),
          React.createElement('span', { className: "font-bold text-sm md:text-base leading-tight break-words max-w-full" },
            data.label
          ),
          data.technology && React.createElement('span', { className: "text-[10px] italic opacity-85 line-clamp-1" },
            '[' + data.technology + ']'
          )
        )
      );
    };

    const nodeTypes = {
      'c4-person': C4Node,
      'c4-software_system': C4Node,
      'c4-container': C4Node,
      'c4-component': C4Node,
    };

    function App() {
      const reactFlowInstance = React.useRef(null);
      const [scopeId, setScopeId] = React.useState(null);
      const [selectedNodeId, setSelectedNodeId] = React.useState(null);
      const [modalContent, setModalContent] = React.useState(null);
      const [theme, setTheme] = React.useState('light');
      const [isFullscreen, setIsFullscreen] = React.useState(false);

      React.useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      React.useEffect(() => {
        const onFullscreenChange = () => setIsFullscreen(!!document.fullscreenElement);
        document.addEventListener('fullscreenchange', onFullscreenChange);
        return () => document.removeEventListener('fullscreenchange', onFullscreenChange);
      }, []);

      const [visibleNodes, setVisibleNodes] = React.useState(() => 
        initialNodes.filter(n => n.data.parentId === null)
      );
      const [visibleEdges, setVisibleEdges] = React.useState(() => {
        const visibleNodeIds = new Set(initialNodes.filter(n => n.data.parentId === null).map(n => n.id));
        return initialEdges.filter(e => visibleNodeIds.has(e.source) && visibleNodeIds.has(e.target));
      });

      React.useEffect(() => {
        const filteredNodes = initialNodes.filter(n => n.data.parentId === scopeId);
        const visibleNodeIds = new Set(filteredNodes.map(n => n.id));
        const filteredEdges = initialEdges.filter(e => visibleNodeIds.has(e.source) && visibleNodeIds.has(e.target));
        
        setVisibleNodes(filteredNodes);
        setVisibleEdges(filteredEdges);

        if (reactFlowInstance.current) {
          setTimeout(() => reactFlowInstance.current.fitView(), 100);
        }
      }, [scopeId]);

      const onInit = (instance) => {
        reactFlowInstance.current = instance;
        setTimeout(() => instance.fitView(), 50);
      };

      const onNodeClick = (event, node) => { setSelectedNodeId(node.id); };
      const onPaneClick = () => { setSelectedNodeId(null); };

      const goUp = () => {
        if (!scopeId) return;
        const currentScopeNode = initialNodes.find(n => n.id === scopeId);
        setScopeId(currentScopeNode?.data.parentId || null);
        setSelectedNodeId(null);
      };

      const goDown = () => {
        if (selectedNodeId) {
          setScopeId(selectedNodeId);
          setSelectedNodeId(null);
        }
      };

      const onViewDescription = () => {
        if (!selectedNodeId) return;
        const node = initialNodes.find(n => n.id === selectedNodeId);
        if (node && node.data.description) {
            setModalContent({ title: node.data.label, description: node.data.description });
        }
      };

      const UpButton = () => {
        if (!scopeId) return null;
        const buttonStyle = {
          position: 'absolute', top: '10px', left: '10px', zIndex: 10,
          padding: '8px 12px', background: 'rgba(45, 45, 48, 0.8)',
          border: '1px solid #5A5A5A', borderRadius: '6px', color: '#E0E0E0',
          cursor: 'pointer', fontSize: '12px', backdropFilter: 'blur(4px)'
        };
        return React.createElement('button', { onClick: goUp, style: buttonStyle }, 'Subir Nível');
      };

      const DescriptionModal = () => {
        if (!modalContent) return null;
        const rawHtml = window.marked.parse(modalContent.description || '');
        const sanitizedHtml = window.DOMPurify.sanitize(rawHtml);
        return React.createElement('div', {
            className: "fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",
            onClick: () => setModalContent(null)
          },
          React.createElement('div', {
              className: "bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 text-gray-900 dark:text-gray-100 max-h-[80vh] overflow-y-auto",
              onClick: e => e.stopPropagation()
            },
            React.createElement('h2', { className: "text-xl font-bold mb-4" }, modalContent.title),
            React.createElement('div', {
              className: "markdown-content",
              dangerouslySetInnerHTML: { __html: sanitizedHtml }
            }),
            React.createElement('button', {
              className: "mt-6 px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded text-sm font-medium",
              onClick: () => setModalContent(null)
            }, 'Fechar')
          )
        );
      };

      const ToolbarButtons = () => {
        if (!selectedNodeId) return null;
        const node = initialNodes.find(n => n.id === selectedNodeId);
        if (!node) return null;
        const isContainer = node.data.c4Type === 'software_system' || node.data.c4Type === 'container';
        const hasChildren = initialNodes.some(n => n.data.parentId === selectedNodeId);
        const hasDescription = node.data.description && node.data.description.trim() !== '';
        const enterButton = isContainer && hasChildren ? React.createElement('button', {
          key: 'enter', onClick: goDown,
          className: 'px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors'
        }, 'Entrar no Contexto') : null;
        const descButton = hasDescription ? React.createElement('button', {
          key: 'desc', onClick: onViewDescription,
          className: 'px-3 py-1.5 bg-gray-500 text-white text-xs rounded hover:bg-gray-600 transition-colors'
        }, 'Ver Descrição') : null;
        return [enterButton, descButton].filter(Boolean);
      };
      
      const CornerButton = ({ onClick, children, top, right }) => {
        return React.createElement('button', {
          onClick,
          className: 'absolute z-10 p-2 rounded-full bg-gray-200/50 dark:bg-gray-700/50 text-gray-800 dark:text-gray-200 backdrop-blur-sm',
          style: { top: top, right: right },
          dangerouslySetInnerHTML: { __html: children }
        });
      };

      const ThemeToggleButton = () => {
        const isDark = theme === 'dark';
        const sunIcon = '<svg xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.95-4.22l-1.591 1.591M5.25 12H3m4.22-4.95L6.03 6.03m7.94 7.94a4.5 4.5 0 11-6.364-6.364 4.5 4.5 0 016.364 6.364z" /></svg>';
        const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>';
        return React.createElement(CornerButton, { onClick: () => setTheme(isDark ? 'light' : 'dark'), top: '10px', right: '10px' }, isDark ? sunIcon : moonIcon);
      };

      const FullscreenButton = () => {
        const handleFullscreen = () => {
          if (!isFullscreen) {
            document.documentElement.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
        };
        const enterIcon = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>';
        const exitIcon = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" /></svg>';
        return React.createElement(CornerButton, { onClick: handleFullscreen, top: '54px', right: '10px' }, isFullscreen ? exitIcon : enterIcon);
      };

      return React.createElement(React.Fragment, null,
        React.createElement(UpButton),
        React.createElement(ThemeToggleButton),
        React.createElement(FullscreenButton),
        React.createElement(DescriptionModal),
        React.createElement(ReactFlow, {
          nodes: visibleNodes,
          edges: visibleEdges,
          nodeTypes: nodeTypes,
          onInit: onInit,
          onNodeClick: onNodeClick,
          onPaneClick: onPaneClick,
          fitView: true,
          nodesDraggable: false,
          nodesConnectable: false,
          elementsSelectable: true,
          panOnDrag: true,
          zoomOnScroll: true,
          children: [
            React.createElement(Background, { key: 'bg', className: "dark:bg-gray-800 bg-gray-50" }),
            React.createElement(Controls, { key: 'ctrls' }),
            React.createElement(MiniMap, { key: 'minimap', pannable: true }),
            React.createElement(NodeToolbar, {
                key: 'toolbar',
                isVisible: selectedNodeId !== null,
                nodeId: selectedNodeId,
                position: Position.Top,
                className: "flex gap-2 bg-white p-1 rounded-md shadow-xl border"
              },
              React.createElement(ToolbarButtons)
            )
          ]
        })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
